{% extends "base.html" %}


{% block content %}
<!-- Home Button -->
<!-- <div class="home-button">
    <a href="{{ url_for('recipes') }}">
        <img src="{{ url_for('static', filename='images/home.png') }}" alt="Home" style="width: 40px; height: 40px;">
    </a>
</div> -->
<div class="top-bar">
    <!-- <a href="{{ url_for('recipes') }}">
        <img src="{{ url_for('static', filename='images/home.png') }}" alt="Home" title="Home" style="width: 40px; height: 40px;">
    </a> -->
    <a href="{{ url_for('recipes') }}" class="recipes-button">Recipes</a>
    <div id="quiz-progress" class="pixel-font">
        Question {{ current_qid }} of {{ total_questions }}
    </div>
</div>

<div class="game-content quiz-layout" style="display: flex; gap:20px; justify-content: center;">
    <!-- Left: Fiona and Backpack -->
    <div class="player-section" style="width: 30%;">
        <div class="character-sprite text-center">
            <img src="{{ url_for('static', filename='images/user_happy.png') }}" width="120">
            <p class="pixel-font">{{ name }}</p>
        </div>
        <p class="pixel-font text-center">Backpack</p>
        <div class="inventory-grid">
            {% for item in ['espresso', 'steamed_milk', 'milk_foam', 'whipped_cream', 'chocolate',
            'water'] %}
            <div class="inventory-slot" draggable="true">
                <img src="{{ url_for('static', filename='images/' + item + '.png') }}" class="item-icon"
                    alt="{{ item }}" title="{{ item }}">
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Center: Crafting Table with Submit Button -->
    <div class="crafting-column">
        <div class="crafting-inner">
            <div class="pixel-font crafting-title">CRAFTING TABLE</div>

            <div class="crafting-grid">
                {% for i in range(9) %}
                <div class="crafting-slot" data-slot="{{ i }}" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% if selected_ingredients and i < selected_ingredients|length and selected_ingredients[i] %} <img
                        src="{{ url_for('static', filename='images/' + selected_ingredients[i] + '.png') }}"
                        class="item-icon" alt="{{ selected_ingredients[i] }}">
                        {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="crafting-arrow">
                <img src="{{ url_for('static', filename='images/crafting-arrow.png') }}" alt="Arrow" class="arrow">
            </div>

            <div class="result-slot {% if result_image in ['None', 'null', '', None] %}empty{% endif %}">
                {% if result_image not in ['None', 'null', '', None] %}
                <img src="{{ url_for('static', filename='images/' + result_image + '.png') }}" class="result-image" 
                    alt="{{ result_image }}" title="{{ result_image }}">
                {% endif %}
            </div>

            <div id="drink-name" class="pixel-font result-drink-name" style="display: none;"></div>
            <!-- <div id="positive-feedback" class="feedback-box success-box" style="display: none;"></div> -->
            <div id="response-text" class="pixel-font result-feedback"></div>
            <!-- <div id="detailed-feedback" class="feedback-box error-box" style="display: none;"></div> -->

            <img id="heart-icon" src="{{ url_for('static', filename='images/heart.png') }}" width="30"
                style="display: none; margin-top: 10px;">
            <div class="text-center mt-4">
                <button id="submit-craft" class="submit-button">Submit</button>
            </div>
              


        </div>
    </div>

    <!-- Right: Dr. Coffee -->
    <div class="professor-section">
        <div class="professor-inner">
            <!-- Dr. Coffee Character -->
            <div class="professor-sprite text-center">
                <img src="{{ url_for('static', filename='images/dr_coffee.png') }}" width="120">
                <p class="pixel-font">Dr. Coffee</p>
            </div>

            <!-- Dr. Coffee's Question -->
            <div class="speech-bubble mt-3 pixel-font">
                {{ question.prompt }}
            </div>

            <!-- Hint Icon -->
            <!-- <div class="hint-icon-wrapper">
                <img id="hint-icon" src="{{ url_for('static', filename='images/hint.png') }}" alt="Hint Icon">
            </div> -->
            <button id="hint-icon" class="pixel-button hint-button" title="Show/Hide Hint">Hint</button>
            <!-- Hint Text -->
            <div id="hint-text" class="pixel-font">
                Hint: {{ question.hint }}
            </div>
            <!-- Feedback  -->
            <div id="positive-feedback" class="feedback-box success-box" style="display: none;"></div>
            <div id="detailed-feedback" class="feedback-box error-box" style="display: none;"></div>
        </div>
    </div>

</div>

<input type="hidden" id="question-id" value="{{ current_qid }}">
<input type="hidden" id="total-questions" value="{{ total_questions }}">
<input type="hidden" id="prefilled-ingredients" value='{{ selected_ingredients | tojson }}'>
<input type="hidden" id="prefilled-result" value="{{ result_image }}">
<input type="hidden" id="prefilled-feedback" value="{{ feedback_text }}">
<input type="hidden" id="prefilled-hint" value="{{ 'true' if hint_shown else 'false' }}">
<input type="hidden" id="prefilled-result-name" value="{{ result_name }}">
<input type="hidden" id="prefilled-feedback-detail" value='{{ feedback_detail | tojson | safe }}'>
<input type="hidden" id="prefilled-positive-feedback" value="{{ positive_feedback }}">


<script>
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drop(ev) {
        ev.preventDefault();
        const ingredient = ev.dataTransfer.getData("text/plain");
        const slot = ev.currentTarget;

        if (window.quizSubmitted) return;

        slot.innerHTML = `<img src="/static/images/${ingredient}.png" class="item-icon" alt="${ingredient}">`;

        const craftingSlots = document.querySelectorAll('.crafting-slot');
        const selectedIngredients = Array.from(craftingSlots).map(slot => {
            const img = slot.querySelector('img');
            return img ? img.alt : null;
        });

        fetch('/save_quiz_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question_id: {{ current_qid }},
                ingredients: selectedIngredients
            })
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const questionId = parseInt(document.getElementById('question-id').value);
        const totalQuestions = parseInt(document.getElementById('total-questions').value);
        const craftingSlots = document.querySelectorAll('.crafting-slot');
        const inventorySlots = document.querySelectorAll('.inventory-slot');
        const resultSlot = document.querySelector('.result-slot');
        const responseText = document.getElementById('response-text');
        const heartIcon = document.getElementById('heart-icon');
        const hintIcon = document.getElementById('hint-icon');
        const hintText = document.getElementById('hint-text');
        const submitBtn = document.getElementById('submit-craft');
        // const drinkNameDiv = document.getElementById('drink-name');
        let isSubmitted = false;

        // Refill from session
        const prefilledIngredients = JSON.parse(document.getElementById('prefilled-ingredients').value);
        const prefilledResult = document.getElementById('prefilled-result').value;
        const prefilledFeedback = document.getElementById('prefilled-feedback').value;
        const prefilledHintShown = document.getElementById('prefilled-hint').value === 'true';
        const prefiledDrinkNameDiv = document.getElementById('drink-name');
        const feedbackDataRaw = document.getElementById("prefilled-feedback-detail")?.value;
        const prefilledPositiveFeedback = document.getElementById('prefilled-positive-feedback')?.value;

        craftingSlots.forEach((slot, i) => {
            if (prefilledIngredients[i]) {
                slot.innerHTML = `<img src="/static/images/${prefilledIngredients[i]}.png" class="item-icon" alt="${prefilledIngredients[i]}">`;
            }

            slot.addEventListener('click', () => {
                if (!isSubmitted) slot.innerHTML = "";
            });
        });

        if (prefilledResult && prefilledResult !== 'None' && prefilledResult !== 'null') {
            isSubmitted = true;
            window.quizSubmitted = true;
        
            resultSlot.innerHTML = `<img src="/static/images/${prefilledResult}.png" class="result-image" alt="${prefilledResult}" title="${prefilledResult}">`;
            resultSlot.classList.remove("empty");
            submitBtn.style.display = 'none';

            if (prefilledFeedback) {
                responseText.innerText = prefilledFeedback;
                responseText.classList.add('pixel-font', 'result-feedback');
                if (prefilledFeedback.toLowerCase().includes("correct")) {
                    prefiledDrinkNameDiv.textContent = document.getElementById('prefilled-result-name').value;
                    prefiledDrinkNameDiv.style.display = 'block';
                    // heartIcon.style.display = 'inline-block';
                    responseText.classList.add('result-correct');
                    if (prefilledPositiveFeedback) {
                        const posBox = document.getElementById('positive-feedback');
                        posBox.textContent = prefilledPositiveFeedback;
                        posBox.style.display = 'block';
                    }
                } else {
                    heartIcon.style.display = 'none';
                    responseText.classList.add('result-wrong');
                }
            }

            if (feedbackDataRaw && !prefilledFeedback.toLowerCase().includes("correct")) {
                const data = { feedback_detail: JSON.parse(feedbackDataRaw) };
                const detailBox = document.getElementById('detailed-feedback');
                detailBox.innerHTML = '';
                detailBox.style.display = 'block';
                const hasMissing = data.feedback_detail.missing?.length;
                const hasExtra = data.feedback_detail.extra?.length;

                if (data.feedback_detail.crafted) {
                    const line = document.createElement('div');
                    line.textContent = data.feedback_detail.crafted;
                    detailBox.appendChild(line);
                } else {
                    if (hasMissing) {
                        const header = document.createElement('strong');
                        header.textContent = "Missing ingredients:";
                        detailBox.appendChild(header);
                        data.feedback_detail.missing.forEach(msg => {
                            const p = document.createElement('div');
                            p.textContent = "! " + msg;
                            detailBox.appendChild(p);
                        });
                    }

                    // ✅ Only add spacer if both missing & extra exist
                    if (hasMissing && hasExtra) {
                        const spacer = document.createElement('div');
                        spacer.style.height = '12px';
                        detailBox.appendChild(spacer);
                    }

                    if (hasExtra) {
                        const header = document.createElement('strong');
                        header.textContent = "Extra ingredients:";
                        detailBox.appendChild(header);
                        data.feedback_detail.extra.forEach(msg => {
                            const p = document.createElement('div');
                            p.textContent = "* " + msg;
                            detailBox.appendChild(p);
                        });
                    }
                }
            }

            // Create button row
            // const buttonRow = document.createElement("div");
            // buttonRow.style.display = "flex";
            // buttonRow.style.gap = "12px";
            // buttonRow.style.justifyContent = "center";
            // buttonRow.style.flexDirection = "row-reverse";
            // buttonRow.className = "mt-3";
            const craftingInner = document.querySelector('.crafting-inner');

            // if (prefilledFeedback && !prefilledFeedback.toLowerCase().includes("correct")) {
            //     const retryBtn = document.createElement("button");
            //     retryBtn.className = "submit-button mt-3";
            //     retryBtn.innerText = "Retry This Question";
            //     retryBtn.onclick = () => {
            //         fetch('/clear_quiz_question', {
            //             method: 'POST',
            //             headers: { 'Content-Type': 'application/json' },
            //             body: JSON.stringify({ question_id: questionId })
            //         }).then(() => {
            //             window.location.reload();
            //         });
            //     };
            //     craftingInner.appendChild(retryBtn);
                
            // }

            const nextBtn = document.createElement("button");
            nextBtn.className = "submit-button mt-3";
            nextBtn.innerText = (questionId === totalQuestions) ? "Finish Quiz" : "Next Question";
            nextBtn.onclick = () => {
                if (questionId === totalQuestions) {
                    window.location.href = '/certificate';
                } else {
                    fetch('/update_last_qid', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question_id: questionId + 1 })
                    }).then(() => {
                        window.location.href = `/quiz/${questionId + 1}`;
                    });
                }
            };
            craftingInner.appendChild(nextBtn);
            // buttonRow.appendChild(nextBtn);
            // Retry button (only if previous answer was incorrect)
        
            // submitBtn.parentElement.appendChild(nextBtn);
            // submitBtn.parentElement.appendChild(buttonRow);

        }

        if (prefilledHintShown) {
            hintText.style.display = 'block';
        }

        inventorySlots.forEach(slot => {
            slot.addEventListener('dragstart', e => {
                if (!isSubmitted) {
                    e.dataTransfer.setData('text/plain', slot.querySelector('img').alt);
                }
            });
        });

        submitBtn.addEventListener('click', () => {
            const selectedIngredients = Array.from(craftingSlots).map(s => {
                const img = s.querySelector('img');
                return img ? img.alt : null;
            });

            fetch('/submit_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question_id: questionId,
                    ingredients: selectedIngredients
                })
            })
                .then(res => res.json())
                .then(data => {
                    isSubmitted = true;
                    window.quizSubmitted = true;
                    resultSlot.innerHTML = `<img src="/static/images/${data.result}.png" class="result-image" alt="${data.result}" title="${data.result}">`;
                    resultSlot.classList.remove("empty");
                    submitBtn.style.display = 'none';

                    if (data.success && data.result_name) {
                        const drinkNameDiv = document.getElementById('drink-name');
                        drinkNameDiv.textContent = data.result_name;
                        drinkNameDiv.style.display = 'block';
                    }

                    if (data.success) {
                        if (data.positive_feedback) {
                            const posBox = document.getElementById('positive-feedback');
                            posBox.textContent = data.positive_feedback;
                            posBox.style.display = 'block';
                        }
                        responseText.innerText = "Correct! You crafted the right drink!";
                        // responseText.style.color = "green";
                    } else {
                        responseText.innerText = "Oops! That’s not the right combination.";
                        // responseText.style.color = "red";
                        const detailBox = document.getElementById('detailed-feedback');
                        detailBox.innerHTML = '';  // clear previous
                        detailBox.style.display = 'block';
                        const hasMissing = data.feedback_detail.missing?.length;
                        const hasExtra = data.feedback_detail.extra?.length;

                        if (data.feedback_detail.crafted) {
                        const line = document.createElement('div');
                        line.textContent = data.feedback_detail.crafted;
                        detailBox.appendChild(line);
                        } else {
                            if (hasMissing) {
                                const header = document.createElement('strong');
                                header.textContent = "Missing ingredients:";
                                detailBox.appendChild(header);
                                data.feedback_detail.missing.forEach(msg => {
                                const p = document.createElement('div');
                                p.textContent = "! " + msg;
                                detailBox.appendChild(p);
                                });
                            }

                            // ✅ Only add spacer if both missing & extra exist
                            if (hasMissing && hasExtra) {
                                const spacer = document.createElement('div');
                                spacer.style.height = '12px';
                                detailBox.appendChild(spacer);
                            }

                            if (hasExtra) {
                                const header = document.createElement('strong');
                                header.textContent = "Extra ingredients:";
                                detailBox.appendChild(header);
                                data.feedback_detail.extra.forEach(msg => {
                                const p = document.createElement('div');
                                p.textContent = "* " + msg;
                                detailBox.appendChild(p);
                                });
                            }
                        }

                    }
                    responseText.classList.add('pixel-font', 'result-feedback');
                    if (data.success) {
                        responseText.classList.add('result-correct');
                        // heartIcon.style.display = 'inline-block';
                    } else {
                        responseText.classList.add('result-wrong');
                        heartIcon.style.display = 'none';
                    }

                    // Create the flex row container
                    // const buttonRow = document.createElement("div");
                    // buttonRow.style.display = "flex";
                    // buttonRow.style.gap = "12px";
                    // buttonRow.style.justifyContent = "center";
                    // buttonRow.style.flexDirection = "row-reverse";
                    // buttonRow.className = "mt-3";
                    const craftingInner = document.querySelector('.crafting-inner');

                    // if (!data.success) {
                    //     const retryBtn = document.createElement("button");
                    //     retryBtn.className = "submit-button mt-3";
                    //     retryBtn.innerText = "Retry This Question";
                    //     retryBtn.onclick = () => {
                    //         fetch('/clear_quiz_question', {
                    //         method: 'POST',
                    //         headers: { 'Content-Type': 'application/json' },
                    //         body: JSON.stringify({ question_id: questionId })
                    //         }).then(() => {
                    //         window.location.reload();
                    //         });
                    //     };
                    //     craftingInner.appendChild(retryBtn);
                    // }

                    const nextBtn = document.createElement("button");
                    nextBtn.className = "submit-button mt-3";
                    nextBtn.innerText = data.finished ? "Finish Quiz" : "Next Question";
                    nextBtn.onclick = () => {
                        if (data.finished) {
                            window.location.href = '/certificate';
                        } else {
                            fetch('/update_last_qid', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ question_id: data.next_qid })
                            }).then(() => {
                                window.location.href = `/quiz/${data.next_qid}`;
                            });
                        }
                    };
                    craftingInner.appendChild(nextBtn);
                    // buttonRow.appendChild(nextBtn);

                    
                    // submitBtn.parentElement.appendChild(nextBtn);
                    // submitBtn.parentElement.appendChild(buttonRow);
                });
        });

        hintIcon.addEventListener('click', () => {
            const isVisible = hintText.style.display === 'block';
            hintText.style.display = isVisible ? 'none' : 'block';
            const route = isVisible ? '/clear_hint_shown' : '/save_hint_shown';
            fetch(route, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question_id: questionId })
            });
        });
    });
</script>




<style>
    .player-section{
        flex:none;
        /* width: 240px; */
        width:30%;
    }
    .crafting-column {
        flex: 1;
        max-width: 320px;  /* Or whatever fits your grid */
        min-width: 320px;
    }
    /* .character-sprite {
        flex:none;
        width: 240px;
    } */
    .item-icon {
        width: 40px;
        height: 40px;
        cursor: grab;
    }
    .item-icon:active {
        cursor: grabbing;
    }
    .inventory-grid{
        display: grid;
        grid-template-columns: repeat(3, 50px);  /* 3 items per row */
        gap: 10px;                                /* small spacing between slots */
        justify-content: center;
    }
    .inventory-slot {
        width: 60px;
        height: 60px;
        border: 2px solid #ccc;
        background-color: #f3f3f3;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .professor-section {
        width: 30%;
    }

    .professor-inner {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        /* Align everything to the left */
    }

    .professor-sprite {
        text-align: center;
        width: 100%;
    }

    .speech-bubble {
        font-size: 14px;
        margin-top: 10px;
        width: 100%;
    }

    .hint-icon-wrapper {
        margin-top: 20px;
        margin-bottom: 5px;
    }


    #hint-icon {
        width: 40px;
        height: 40px;
        cursor: pointer;
    }

    #hint-text {
        font-size: 13px;
        margin-top: 8px;
        display: none;
        background-color: #fffaf5;
        /* soft light background */
        padding: 10px 14px;
        border: 2px solid #d78f46;
        /* warm orange border */
        border-radius: 12px;
        /* rounded corners */
        color: #333;
        width: fit-content;
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.05);
        /* optional soft shadow */
    }

    .result-slot {
        width: 100px;
        height: 100px;
        margin: auto;
        border: 2px solid #4a4a4a;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .result-slot.empty {
        border: 2px dashed #ccc;
        background-color: #f8f8f8;
    }

    .result-slot img.result-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }


    .result-correct {
        color: green;
    }

    .result-wrong {
        color: red;
    }

    .result-feedback {
        margin-top: 15px;
        font-size: 14px;
        text-align: center;
        min-height: 24px;
    }

    .crafting-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .crafting-slot {
        width: 80px;
        height: 80px;
        border: 2px solid #ccc;
        background-color: #f3f3f3;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .crafting-arrow {
        text-align: center;
        margin: 10px 0;
    }

    .crafting-arrow .arrow {
        width: 40px;
        height: auto;
    }

    .crafting-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .crafting-title {
        margin-bottom: 12px;
        text-align: center;
    }

    .hint-button {
        background-color: #fff8c6;
        border: 2px solid #f7c174;
        color: #5c4b00;
        font-weight: bold;
        padding: 8px 20px;
        min-width: 100px;
        /* slightly wider for balance */
        text-align: center;
        /* ensures text is centered */
        display: inline-block;
        /* allows it to size naturally */
        line-height: 1.2;
        /* prevents vertical misalignment */
        transition: background-color 0.2s ease;
        margin-top: 20px;
        font-size: 13px;
    }


    .hint-button:hover {
        background-color: #fff3a2;
        cursor: pointer;
    }

    .top-bar {
        position: absolute;
        top: 20px;
        left: 30px;
        display: flex;
        align-items: center;
        gap: 16px;
    }


    #quiz-progress {
        font-size: 12px;
        color: #4a4a4a;
        /* background-color: #fff8c6; */
        /* border: 2px solid #f7c174; */
        padding: 6px 12px;
        border-radius: 6px;
        /* box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1); */
    }

    .quiz-layout {
        margin-top: 80px;
        /* margin-left: 80px;
        margin-right: 80px; */
        /* Adjust as needed */
    }

    .submit-button {
        background-color: #cc8753;
        /* warm brown color */
        border: none;
        border-radius: 15px;
        padding: 12px 30px;
        font-family: 'Press Start 2P', cursive;
        /* or your pixel font */
        font-size: 18px;
        color: black;
        cursor: pointer;
        text-align: center;
        margin-top: 20px;
        display: inline-block;
        white-space: normal;        /* 👈 allow line wrapping */
        max-width: 250px;           /* 👈 limit horizontal growth */
        line-height: 1.5;
    }

    .feedback-box {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
    }

    .success-box {
        background-color: #e7fbe9;
        border: 2px solid #75c77f;
        color: #2c662d;
    }

    .error-box {
        background-color: #fff3f3;
        border: 2px solid #e27474;
        color: #8c2b2b;
    }

</style>



{% endblock %}