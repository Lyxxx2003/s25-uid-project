{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/introduction.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="container">
  <!-- Top row with title and home icon -->
  <div class="intro-header-row">
    <div class="home-icon-container">
      <a href="{{ url_for('recipes') }}" class="recipes-button">Recipes</a>
    </div>
    <h1 class="main-title intro-title">Caf√©Craft</h1>
    <div class="home-icon-container">
      <!-- <a href="{{ url_for('recipes') }}">
        <img src="{{ url_for('static', filename='images/home.png') }}" alt="Home" class="home-icon">
      </a> -->
      <!-- Empty space to balance layout -->
    </div>
  </div>

  <!-- Three column layout for main content -->
  <div class="intro-content">
    <!-- User Column (Left) -->
    <div class="character-column">
      <img src="{{ url_for('static', filename='images/user_tired.png') }}" alt="User" class="character-portrait">
      <div class="pixel-font character-name">{{ name }}</div>

      <!-- Coffee Level -->
      <div class="coffee-level mb-5">
        {% for i in range(6) %}
        {% if i < caffeine_level %} <img src="{{ url_for('static', filename='images/coffee_beans.png') }}"
          alt="Filled Bean" class="coffee-bean">
          {% else %}
          <img src="{{ url_for('static', filename='images/coffee_beans.png') }}" alt="Empty Bean"
            class="coffee-bean bean-empty">
          {% endif %}
          {% endfor %}
      </div>

      <!-- Backpack -->
      <div class="backpack">
        <div class="pixel-font backpack-title text-center">BACKPACK</div>
        <div class="backpack-grid">
          {% for ingredient in recipe.ingredients %}
          <div class="backpack-slot d-flex justify-content-center align-items-center">
            <img src="{{ url_for('static', filename='images/' + items[ingredient].icon) }}"
              alt="{{ items[ingredient].name }}" draggable="true" ondragstart="drag(event)"
              data-ingredient="{{ ingredient }}" class="backpack-item" title="{{ items[ingredient].name }}">
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Crafting Column (Middle) -->
    <div class="crafting-column">
      <div class="craft-coffee-name">
        <div class="pixel-font crafting-title">{{ recipe.name }}</div>
      </div>
      <div class="pixel-font crafting-title">CRAFTING TABLE</div>
      <div class="crafting-table">
        <div class="crafting-grid" id="craftingGrid">
          {% for i in range(9) %}
          <div class="crafting-slot d-flex justify-content-center align-items-center" data-slot="{{ i }}"
            ondrop="drop(event)" ondragover="allowDrop(event)">
          </div>
          {% endfor %}
        </div>
        <div class="crafting-arrow mb-3">
          <img src="{{ url_for('static', filename='images/crafting-arrow.png') }}" alt="Arrow" class="arrow">
        </div>
        <div class="result-slot" id="resultSlot"></div>
      </div>
      <div id="feedbackButton" style="display: none;" class="quiz-button-container">
        <a href="{{ url_for('feedback', recipe_id=recipe_id) }}" class="continue-button">Continue</a>
      </div>
    </div>

    <!-- Dr. Coffee Column (Right) -->
    <div class="character-column">
      <img src="{{ url_for('static', filename='images/dr_coffee.png') }}" alt="Dr. Coffee" class="character-portrait">
      <div class="pixel-font character-name">Dr. Coffee</div>

      <!-- Coffee Level (for symmetry) -->
      <div class="coffee-level">
      </div>

      <!-- Speech Bubble -->
      <div class="speech-bubble">

      </div>
    </div>
  </div>

  <script>
    let usedIngredients = [];
  
    // üç≥ Restore saved grid on page load
    window.addEventListener('DOMContentLoaded', () => {
        const currentRecipeId = "{{ recipe_id }}";
        const savedFor = sessionStorage.getItem('recipeId');
  
        if (savedFor !== currentRecipeId) {
            sessionStorage.removeItem('craftingGrid');
            sessionStorage.setItem('recipeId', currentRecipeId);
        }
  
        const savedState = JSON.parse(sessionStorage.getItem('craftingGrid'));
        if (savedState && Array.isArray(savedState)) {
            savedState.forEach((ingredient, i) => {
                if (ingredient) {
                    const slot = document.querySelector(`.crafting-slot[data-slot="${i}"]`);
                    const img = document.createElement('img');
                    img.src = `/static/images/${ingredient}.png`;
                    img.draggable = true;
                    img.ondragstart = drag;
                    img.dataset.ingredient = ingredient;
                    img.classList.add('crafting-item');
                    img.addEventListener('click', removeItem);
                    slot.innerHTML = '';
                    slot.appendChild(img);
                    slot.classList.add('d-flex', 'justify-content-center', 'align-items-center');
                    usedIngredients.push(ingredient);
                }
            });
            checkRecipe();
        }
    });
  
    // üíæ Save current crafting grid to sessionStorage
    function saveCraftingState() {
        const state = [];
        document.querySelectorAll('.crafting-slot').forEach(slot => {
            const img = slot.querySelector('img');
            state.push(img ? img.dataset.ingredient : null);
        });
        sessionStorage.setItem('craftingGrid', JSON.stringify(state));
    }
  
    function allowDrop(ev) {
        ev.preventDefault();
    }
  
    function drag(ev) {
        ev.dataTransfer.setData("ingredient", ev.target.dataset.ingredient);
  
        const resultSlot = document.getElementById('resultSlot');
        if (resultSlot.innerHTML.trim() !== '') {
            ev.preventDefault();
            return false;
        }
  
        const craftingSlot = ev.target.closest('.crafting-slot');
        if (craftingSlot) {
            ev.dataTransfer.setData("from-slot", craftingSlot.dataset.slot);
  
            ev.target.addEventListener('dragend', function(e) {
                if (resultSlot.innerHTML.trim() !== '') return;
  
                const craftingGrid = document.getElementById('craftingGrid');
                const gridRect = craftingGrid.getBoundingClientRect();
  
                if (e.clientX < gridRect.left || e.clientX > gridRect.right ||
                    e.clientY < gridRect.top || e.clientY > gridRect.bottom) {
  
                    const oldSlot = document.querySelector(`.crafting-slot[data-slot="${craftingSlot.dataset.slot}"]`);
                    if (oldSlot) {
                        const ingredient = this.dataset.ingredient;
                        oldSlot.innerHTML = '';
  
                        const ingredientIndex = usedIngredients.indexOf(ingredient);
                        if (ingredientIndex > -1) {
                            usedIngredients.splice(ingredientIndex, 1);
                        }
  
                        document.getElementById('resultSlot').innerHTML = '';
                        document.getElementById('feedbackButton').style.display = 'none';
  
                        saveCraftingState(); // Save after item removal
                    }
                }
            }, {once: true});
        }
    }
  
    function drop(ev) {
        ev.preventDefault();
        const ingredient = ev.dataTransfer.getData("ingredient");
        const fromSlot = ev.dataTransfer.getData("from-slot");
  
        const slot = ev.target.classList.contains('crafting-slot') ?
            ev.target :
            ev.target.closest('.crafting-slot');
  
        if (!slot) return;
  
        if (fromSlot) {
            const oldSlot = document.querySelector(`.crafting-slot[data-slot="${fromSlot}"]`);
            if (oldSlot) {
                oldSlot.innerHTML = '';
                const slotIndex = parseInt(fromSlot);
                const ingredientIndex = usedIngredients.indexOf(ingredient);
                if (ingredientIndex > -1) {
                    usedIngredients.splice(ingredientIndex, 1);
                }
            }
        }
  
        if (!slot.querySelector('img')) {
            const img = document.createElement('img');
            img.src = `/static/images/${ingredient}.png`;
            img.draggable = true;
            img.ondragstart = drag;
            img.dataset.ingredient = ingredient;
            img.classList.add('crafting-item');
            img.addEventListener('click', removeItem);
  
            slot.innerHTML = '';
            slot.appendChild(img);
            slot.classList.add('d-flex', 'justify-content-center', 'align-items-center');
  
            usedIngredients.push(ingredient);
            checkRecipe();
            saveCraftingState(); // Save after drop
        }
    }
  
    function removeItem(ev) {
        const slot = ev.target.closest('.crafting-slot');
        if (!slot) return;
  
        const resultSlot = document.getElementById('resultSlot');
        if (resultSlot.innerHTML.trim() !== '') return;
  
        const ingredient = ev.target.dataset.ingredient;
        slot.innerHTML = '';
  
        const ingredientIndex = usedIngredients.indexOf(ingredient);
        if (ingredientIndex > -1) {
            usedIngredients.splice(ingredientIndex, 1);
        }
  
        document.getElementById('resultSlot').innerHTML = '';
        document.getElementById('feedbackButton').style.display = 'none';
        saveCraftingState(); // Save after removal
    }
  
    function checkRecipe() {
        fetch('/craft_result', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recipe_id: '{{ recipe_id }}',
                ingredients: usedIngredients
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resultSlot = document.getElementById('resultSlot');
                    resultSlot.innerHTML = `<div class="d-flex flex-column align-items-center">
                      <img src="/static/images/{{ recipe_id }}.png" alt="{{ recipe.name }}" class="result-item">
                      <div class="pixel-font text-center mt-2">{{ recipe.name }}</div>
                    </div>`;
  
                    document.getElementById('feedbackButton').style.display = 'block';
                    updateCaffeineLevel(data.caffeine_level);
  
                    const slots = document.querySelectorAll('.crafting-slot');
                    slots.forEach(slot => {
                        slot.ondrop = null;
                        slot.ondragover = null;
                    });
  
                    // ‚úÖ Do NOT clear sessionStorage here
                } else {
                    document.getElementById('resultSlot').innerHTML = '';
                    document.getElementById('feedbackButton').style.display = 'none';
                }
            });
    }
  
    function updateCaffeineLevel(level) {
        const coffeeIcons = document.querySelectorAll('.coffee-bean');
        coffeeIcons.forEach((icon, index) => {
            if (index < level) {
                icon.classList.remove('bean-empty');
            } else {
                icon.classList.add('bean-empty');
            }
        });
    }
  
    // ‚úÖ Clear sessionStorage only when user clicks Continue
    document.getElementById('feedbackButton').addEventListener('click', () => {
        sessionStorage.removeItem('craftingGrid');
        sessionStorage.removeItem('recipeId');
    });
  </script>
  


  {% endblock %}